name: Weekly Trade Bot

on:
  workflow_dispatch: {}         # allow manual runs
  schedule:
    # Run every Monday at 12:00pm US/Eastern (midday market) (9:00am US/Pacific)
    # 17:00 UTC = 12:00pm EST (Nov–Mar), 16:00 UTC = 12:00pm EDT (Mar–Nov)
    - cron: '0 17 * * MON'

permissions:
  contents: read

concurrency:
  group: weekly-trade-bot
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DISCORD_WEBHOOK_URL_TEST: ${{ secrets.DISCORD_WEBHOOK_URL_TEST }}
      DB_TARGET: REMOTE_GH_WORKER
      DATABASE_URL_REMOTE_GH_WORKER: ${{ secrets.DATABASE_URL_REMOTE_GH_WORKER }}
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Sync deps
        run: uv sync --all-extras

      - name: Run weekly trade workflow
        run: |
          uv run -m stock_ai.main_trade
